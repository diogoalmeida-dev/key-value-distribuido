events { worker_connections 1024; }

http {
  upstream envoy_backend  { server envoy:8080; }

  # Cabeçalhos comuns
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  server {
    listen 80;

    # Health-check próprio do NGINX
    location /nginx_health {
      return 200 'nginx up';
      add_header Content-Type text/plain;
    }

    # Swagger UI do Gateway (acesso directo, poupa um salto)
    location = /        { return 302 /docs; }
    location /docs      { proxy_pass http://envoy_backend; }
    location /redoc     { proxy_pass http://envoy_backend; }
    location = /openapi.json { proxy_pass http://envoy_backend/openapi.json; }

    # API completa (qualquer rota) → Envoy
    location / {
      proxy_pass http://envoy_backend;
    }
  }
}